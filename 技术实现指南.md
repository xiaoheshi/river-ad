# æŠ€æœ¯å®ç°æŒ‡å—
## River-AD ä¼˜æƒ å¹³å° - ç‹¬ç«‹å¼€å‘è€…ç‰ˆæœ¬

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„æ¦‚è§ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

### æŠ€æœ¯æ ˆå†³ç­–ï¼ˆä¸ªäººå¼€å‘å‹å¥½ï¼‰
```
åç«¯æ¡†æ¶: Spring Boot 3.2.x (å•ä½“åº”ç”¨)
å¼€å‘è¯­è¨€: Java 17 LTS
æ•°æ®åº“: PostgreSQL 15+ (ä¸»åº“), Redis 7+ (ç¼“å­˜)
å‰ç«¯: React 18 + Next.js
éƒ¨ç½²: Docker Compose (ç®€åŒ–éƒ¨ç½²)
ç›‘æ§: åŸºç¡€æ—¥å¿— + Spring Actuator
```

### å•ä½“æ¶æ„è®¾è®¡ï¼ˆé€‚åˆä¸ªäººå¼€å‘ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Spring Boot Application              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controller Layer  â”‚  Service Layer  â”‚  Repository Layer â”‚
â”‚  (REST API)        â”‚  (ä¸šåŠ¡é€»è¾‘)      â”‚  (æ•°æ®è®¿é—®)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           æ•°æ®å±‚                                        â”‚
â”‚     PostgreSQL (ä¸»æ•°æ®) â”‚ Redis (ç¼“å­˜)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆé€‰æ‹©å•ä½“æ¶æ„ï¼Ÿ**
- ç®€åŒ–éƒ¨ç½²å’Œç»´æŠ¤
- é™ä½ç³»ç»Ÿå¤æ‚åº¦
- é€‚åˆå•äººå¼€å‘èŠ‚å¥
- åæœŸå¯æ‹†åˆ†å¾®æœåŠ¡

## ğŸ“Š æ•°æ®åº“æ¶æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰

### ä¸»æ•°æ®åº“æ¶æ„ (PostgreSQL)

```sql
-- ç”¨æˆ·è¡¨ (ç®€åŒ–ç‰ˆ)
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    preferred_language VARCHAR(5) DEFAULT 'en',
    preferred_currency VARCHAR(3) DEFAULT 'USD',
    is_active BOOLEAN DEFAULT true,
    email_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä¼˜æƒ è¡¨ (æ ¸å¿ƒè¡¨)
CREATE TABLE deals (
    id BIGSERIAL PRIMARY KEY,
    title_en VARCHAR(500) NOT NULL,
    title_zh VARCHAR(500),
    description_en TEXT,
    description_zh TEXT,
    
    original_price DECIMAL(10,2),
    sale_price DECIMAL(10,2),
    currency VARCHAR(3) DEFAULT 'USD',
    discount_percentage INTEGER,
    
    store_name VARCHAR(200) NOT NULL,
    category VARCHAR(100),
    
    affiliate_url TEXT NOT NULL,
    image_url TEXT,
    coupon_code VARCHAR(50),
    
    start_date TIMESTAMP,
    end_date TIMESTAMP,
    is_active BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    
    click_count INTEGER DEFAULT 0,
    view_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç‚¹å‡»è·Ÿè¸ªè¡¨ (ç®€åŒ–ç‰ˆ)
CREATE TABLE clicks (
    id BIGSERIAL PRIMARY KEY,
    deal_id BIGINT REFERENCES deals(id),
    user_id BIGINT REFERENCES users(id),
    ip_address INET,
    user_agent TEXT,
    referrer TEXT,
    clicked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_id VARCHAR(255)
);

-- ç”¨æˆ·æ”¶è—è¡¨
CREATE TABLE favorites (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    deal_id BIGINT REFERENCES deals(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, deal_id)
);

-- åŸºç¡€ç´¢å¼•
CREATE INDEX idx_deals_active ON deals(is_active, created_at DESC);
CREATE INDEX idx_deals_category ON deals(category, is_active);
CREATE INDEX idx_deals_store ON deals(store_name, is_active);
CREATE INDEX idx_clicks_deal_date ON clicks(deal_id, clicked_at);
```

### ç¼“å­˜ç­–ç•¥ (Redis) - ç®€åŒ–ç‰ˆ

```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(15))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));

        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            .build();
    }
}
```

## ğŸ¯ æ ¸å¿ƒæœåŠ¡å®ç°

### 1. ä¼˜æƒ æœåŠ¡ (Deal Service)

```java
@RestController
@RequestMapping("/api/v1/deals")
@CrossOrigin(origins = "*")
public class DealController {

    @Autowired
    private DealService dealService;

    @GetMapping
    public ResponseEntity<PagedResponse<DealDto>> getDeals(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(required = false) String category,
            @RequestParam(required = false) String search,
            @RequestParam(defaultValue = "created_at") String sortBy,
            @RequestHeader(value = "Accept-Language", defaultValue = "en") String language) {
        
        PagedResponse<DealDto> deals = dealService.getDeals(
            PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, sortBy)),
            category, search, language
        );
        
        return ResponseEntity.ok(deals);
    }

    @GetMapping("/{id}")
    @Cacheable(value = "deals", key = "#id + '_' + #language")
    public ResponseEntity<DealDto> getDeal(
            @PathVariable Long id,
            @RequestHeader(value = "Accept-Language", defaultValue = "en") String language) {
        
        DealDto deal = dealService.getDeal(id, language);
        return ResponseEntity.ok(deal);
    }

    @PostMapping("/{id}/click")
    public ResponseEntity<ClickResponse> trackClick(
            @PathVariable Long id,
            HttpServletRequest request) {
        
        String trackingUrl = dealService.trackClick(id, request);
        return ResponseEntity.ok(new ClickResponse(trackingUrl));
    }
}

@Service
@Transactional
public class DealService {

    @Autowired
    private DealRepository dealRepository;
    
    @Autowired
    private ClickService clickService;

    public PagedResponse<DealDto> getDeals(Pageable pageable, String category, 
                                         String search, String language) {
        
        Specification<Deal> spec = Specification.where(null);
        spec = spec.and((root, query, cb) -> cb.equal(root.get("isActive"), true));
        
        if (StringUtils.hasText(category)) {
            spec = spec.and((root, query, cb) -> 
                cb.equal(root.get("category"), category));
        }
        
        if (StringUtils.hasText(search)) {
            spec = spec.and((root, query, cb) -> {
                String pattern = "%" + search.toLowerCase() + "%";
                return cb.or(
                    cb.like(cb.lower(root.get("titleEn")), pattern),
                    cb.like(cb.lower(root.get("titleZh")), pattern)
                );
            });
        }
        
        Page<Deal> deals = dealRepository.findAll(spec, pageable);
        
        return new PagedResponse<>(
            deals.getContent().stream()
                .map(deal -> convertToDto(deal, language))
                .collect(Collectors.toList()),
            deals.getNumber(),
            deals.getSize(),
            deals.getTotalElements(),
            deals.getTotalPages(),
            deals.isLast()
        );
    }

    public String trackClick(Long dealId, HttpServletRequest request) {
        Deal deal = dealRepository.findById(dealId)
            .orElseThrow(() -> new ResourceNotFoundException("Deal not found"));
        
        // è®°å½•ç‚¹å‡»
        clickService.recordClick(dealId, request);
        
        // æ›´æ–°ç‚¹å‡»è®¡æ•°
        dealRepository.incrementClickCount(dealId);
        
        // è¿”å›è·Ÿè¸ªURL
        return generateTrackingUrl(deal.getAffiliateUrl(), dealId);
    }

    private String generateTrackingUrl(String originalUrl, Long dealId) {
        try {
            URI uri = new URI(originalUrl);
            String query = uri.getQuery();
            
            StringBuilder trackingUrl = new StringBuilder(originalUrl);
            if (query == null || query.isEmpty()) {
                trackingUrl.append("?");
            } else {
                trackingUrl.append("&");
            }
            
            trackingUrl.append("utm_source=riverad")
                      .append("&utm_medium=affiliate")
                      .append("&utm_campaign=deals")
                      .append("&deal_id=").append(dealId);
            
            return trackingUrl.toString();
            
        } catch (URISyntaxException e) {
            log.error("Invalid URL: {}", originalUrl, e);
            return originalUrl;
        }
    }
}
```

### 2. ç”¨æˆ·æœåŠ¡ (User Service) - ç®€åŒ–ç‰ˆ

```java
@RestController
@RequestMapping("/api/v1/auth")
public class AuthController {

    @Autowired
    private UserService userService;

    @PostMapping("/register")
    public ResponseEntity<AuthResponse> register(@Valid @RequestBody RegisterRequest request) {
        AuthResponse response = userService.register(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }

    @PostMapping("/login")
    public ResponseEntity<AuthResponse> login(@Valid @RequestBody LoginRequest request) {
        AuthResponse response = userService.authenticate(request);
        return ResponseEntity.ok(response);
    }
}

@Service
@Transactional
public class UserService {

    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private JwtTokenProvider jwtTokenProvider;

    public AuthResponse register(RegisterRequest request) {
        if (userRepository.existsByEmail(request.getEmail())) {
            throw new BadRequestException("Email already in use");
        }

        User user = new User();
        user.setEmail(request.getEmail());
        user.setFirstName(request.getFirstName());
        user.setLastName(request.getLastName());
        user.setPasswordHash(passwordEncoder.encode(request.getPassword()));
        user.setPreferredLanguage(request.getPreferredLanguage());

        User savedUser = userRepository.save(user);
        String token = jwtTokenProvider.generateToken(savedUser.getEmail());

        return new AuthResponse(token, convertToDto(savedUser));
    }
}
```

### 3. ç‚¹å‡»è·Ÿè¸ªæœåŠ¡

```java
@Service
public class ClickService {

    @Autowired
    private ClickRepository clickRepository;

    public void recordClick(Long dealId, HttpServletRequest request) {
        Click click = new Click();
        click.setDealId(dealId);
        click.setIpAddress(getClientIP(request));
        click.setUserAgent(request.getHeader("User-Agent"));
        click.setReferrer(request.getHeader("Referer"));
        click.setSessionId(request.getSession().getId());
        click.setClickedAt(LocalDateTime.now());
        
        clickRepository.save(click);
    }

    private String getClientIP(HttpServletRequest request) {
        String xForwardedFor = request.getHeader("X-Forwarded-For");
        if (xForwardedFor != null && !xForwardedFor.isEmpty()) {
            return xForwardedFor.split(",")[0].trim();
        }
        return request.getRemoteAddr();
    }
}
```

## ğŸŒ å›½é™…åŒ– (i18n) å®ç°

```java
@Configuration
public class I18nConfig {

    @Bean
    public LocaleResolver localeResolver() {
        AcceptHeaderLocaleResolver resolver = new AcceptHeaderLocaleResolver();
        resolver.setSupportedLocales(Arrays.asList(Locale.US, Locale.SIMPLIFIED_CHINESE));
        resolver.setDefaultLocale(Locale.US);
        return resolver;
    }

    @Bean
    public MessageSource messageSource() {
        ResourceBundleMessageSource messageSource = new ResourceBundleMessageSource();
        messageSource.setBasenames("messages");
        messageSource.setDefaultEncoding("UTF-8");
        messageSource.setUseCodeAsDefaultMessage(true);
        return messageSource;
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼ˆå®ç”¨ç‰ˆï¼‰

### 1. æ•°æ®åº“ä¼˜åŒ–

```yaml
# application.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
  
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true
```

### 2. ç¼“å­˜ç­–ç•¥

```java
@Component
public class DealCacheService {

    @Cacheable(value = "deals", key = "#dealId + '_' + #language")
    public DealDto getCachedDeal(Long dealId, String language) {
        return dealService.getDeal(dealId, language);
    }

    @Cacheable(value = "featured_deals", key = "#language")
    public List<DealDto> getFeaturedDeals(String language) {
        return dealService.getFeaturedDeals(language);
    }

    @CacheEvict(value = {"deals", "featured_deals"}, allEntries = true)
    public void clearAllCache() {
        // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
    }
}
```

## ğŸ“Š ç›‘æ§é…ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰

```java
@Configuration
public class MonitoringConfig {

    @Bean
    public MeterRegistry meterRegistry() {
        return new SimpleMeterRegistry();
    }

    @EventListener
    public void handleDealClick(DealClickEvent event) {
        Metrics.counter("deal.clicks", "deal_id", event.getDealId().toString()).increment();
    }
}

// å¥åº·æ£€æŸ¥
@Component
public class CustomHealthIndicator implements HealthIndicator {

    @Autowired
    private DealRepository dealRepository;

    @Override
    public Health health() {
        try {
            long count = dealRepository.count();
            if (count > 0) {
                return Health.up()
                    .withDetail("deals.count", count)
                    .build();
            } else {
                return Health.down()
                    .withDetail("deals.count", 0)
                    .build();
            }
        } catch (Exception e) {
            return Health.down(e).build();
        }
    }
}
```

## ğŸ”’ å®‰å…¨é…ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(10);
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().disable()
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/v1/auth/**").permitAll()
                .requestMatchers("/api/v1/deals/**").permitAll()
                .requestMatchers("/actuator/health").permitAll()
                .anyRequest().authenticated()
            )
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);

        return http.build();
    }
}
```

## ğŸ³ Docker éƒ¨ç½²é…ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰

### Dockerfile
```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/river-ad-*.jar app.jar

HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["java", "-jar", "/app/app.jar"]

EXPOSE 8080
```

### docker-compose.yml
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: riverad-postgres
    environment:
      POSTGRES_DB: riverad
      POSTGRES_USER: riverad
      POSTGRES_PASSWORD: ${DB_PASSWORD:-riverad123}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - riverad-network

  redis:
    image: redis:7-alpine
    container_name: riverad-redis
    ports:
      - "6379:6379"
    networks:
      - riverad-network

  backend:
    build: .
    container_name: riverad-backend
    depends_on:
      - postgres
      - redis
    environment:
      SPRING_PROFILES_ACTIVE: production
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/riverad
      SPRING_DATASOURCE_USERNAME: riverad
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-riverad123}
      SPRING_REDIS_HOST: redis
      JWT_SECRET: ${JWT_SECRET:-your-secret-key}
    ports:
      - "8080:8080"
    networks:
      - riverad-network
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  riverad-network:
    driver: bridge
```

## ğŸ› ï¸ å¼€å‘å·¥å…·é…ç½®

### application.yml (å¼€å‘ç¯å¢ƒ)
```yaml
spring:
  profiles:
    active: development
  
  datasource:
    url: jdbc:postgresql://localhost:5432/riverad
    username: riverad
    password: riverad123
  
  jpa:
    show-sql: true
    hibernate:
      ddl-auto: update
  
  redis:
    host: localhost
    port: 6379
  
  cache:
    type: redis

server:
  port: 8080

logging:
  level:
    com.riverad: DEBUG
    org.springframework.web: DEBUG
```

## ğŸ“ APIæ–‡æ¡£é…ç½®

```java
@Configuration
@EnableOpenApi
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
            .info(new Info()
                .title("River-AD API")
                .version("1.0")
                .description("æµ·å¤–ä¼˜æƒ å¹³å°APIæ–‡æ¡£"))
            .servers(List.of(
                new Server().url("http://localhost:8080").description("å¼€å‘ç¯å¢ƒ"),
                new Server().url("https://api.riverad.com").description("ç”Ÿäº§ç¯å¢ƒ")
            ));
    }
}
```

## ğŸš€ éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh

echo "ğŸš€ å¼€å§‹éƒ¨ç½² River-AD..."

# æ„å»ºåº”ç”¨
echo "ğŸ“¦ æ„å»ºåº”ç”¨..."
./mvnw clean package -DskipTests

# æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
echo "ğŸ³ å¯åŠ¨æœåŠ¡..."
docker-compose down
docker-compose up --build -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# å¥åº·æ£€æŸ¥
echo "ğŸ¥ è¿›è¡Œå¥åº·æ£€æŸ¥..."
curl -f http://localhost:8080/actuator/health

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€: http://localhost:8080"
echo "ğŸ“Š ç›‘æ§åœ°å€: http://localhost:8080/actuator"
```

---

**ä¸ªäººå¼€å‘è€…æŠ€æœ¯å»ºè®®**:

1. **ä»ç®€å•å¼€å§‹**: å•ä½“æ¶æ„ï¼Œé¿å…è¿‡åº¦å·¥ç¨‹åŒ–
2. **é€æ­¥ä¼˜åŒ–**: å…ˆå®ç°åŠŸèƒ½ï¼Œå†ä¼˜åŒ–æ€§èƒ½
3. **åˆç†ç¼“å­˜**: åªç¼“å­˜çœŸæ­£éœ€è¦çš„æ•°æ®
4. **ç›‘æ§è¦ç‚¹**: å…³æ³¨æ ¸å¿ƒæŒ‡æ ‡ï¼Œé¿å…ç›‘æ§è¿‡è½½
5. **å®‰å…¨ç¬¬ä¸€**: åŸºç¡€å®‰å…¨é…ç½®å¿…é¡»åˆ°ä½
6. **æ–‡æ¡£é½å…¨**: APIæ–‡æ¡£å’Œéƒ¨ç½²æ–‡æ¡£è¦å®Œæ•´

*è®°ä½ï¼šæœ€å¥½çš„æ¶æ„æ˜¯èƒ½å¤Ÿå¿«é€Ÿäº¤ä»˜ä»·å€¼çš„æ¶æ„ï¼*